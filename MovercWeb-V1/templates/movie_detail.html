<!-- templates/movie_detail.html -->
{% extends "base.html" %}

{% block title %}{{ movie.NAME or "ç”µå½±è¯¦æƒ…" }}{% endblock %}

{% block content %}
<div class="movie-detail">
    <h1>{{ movie.NAME }} {% if movie.YEAR %}({{ movie.YEAR }}){% endif %}</h1>

    {% if movie.COVER %} {# å‡è®¾ CSV ä¸­æœ‰æµ·æŠ¥é“¾æ¥å­—æ®µ #}
        <img src="{{ movie.COVER }}" alt="{{ movie.NAME }} Poster" style="max-width: 200px; float: left; margin-right: 20px;">
    {% endif %}

    <p><strong>å¯¼æ¼”:</strong> {{ movie.DIRECTOR or "æœªçŸ¥" }}</p>
    <p><strong>ä¸»æ¼”:</strong> {{ movie.CAST or "æœªçŸ¥" }}</p>
    <p><strong>ç±»å‹:</strong> {{ movie.GENRES or "æœªçŸ¥" }}</p>
    <p><strong>è¯„åˆ†:</strong> {{ "%.1f"|format(movie.RATING) if movie.RATING else "æš‚æ— è¯„åˆ†" }}</p>
    <p><strong>ç®€ä»‹:</strong></p>
    <p>{{ movie.PLOT_SUMMARY or movie.DESCRIPTION or "æš‚æ— ç®€ä»‹" }}</p> {# å‡è®¾æœ‰æ‘˜è¦æˆ–æè¿°å­—æ®µ #}

    <div style="clear: both;"></div> <!-- æ¸…é™¤æµ®åŠ¨ -->

    <!-- åå¥½æŒ‰é’®åŒº -->
    {% if current_user.is_authenticated %}
    <div>
        <p><strong>ä½ çš„è¯„ä»·:</strong></p>
        
        <!-- å–œæ¬¢æŒ‰é’® -->
        <button id="like-btn" class="pref-btn" data-action="like"
                style="{% if user_has_liked %}background-color: green; color: white;{% endif %}">
            {% if user_has_liked %}âœ“ å·²å–œæ¬¢{% else %}ğŸ‘ å–œæ¬¢{% endif %}
        </button>

        <!-- ä¸å–œæ¬¢æŒ‰é’® -->
        <button id="dislike-btn" class="pref-btn" data-action="dislike"
                style="{% if user_has_disliked %}background-color: red; color: white;{% endif %}">
            {% if user_has_disliked %}âœ— å·²ä¸å–œæ¬¢{% else %}ğŸ‘ ä¸å–œæ¬¢{% endif %}
        </button>

        <!-- ç§»é™¤åå¥½æŒ‰é’® (å¯é€‰ï¼Œé€šè¿‡å†æ¬¡ç‚¹å‡»ç›¸åŒæŒ‰é’®å®ç°) -->
        <!-- æœ¬å®ç°ä¸­ï¼Œå†æ¬¡ç‚¹å‡»â€œå–œæ¬¢â€ä¼šå˜æˆâ€œå–æ¶ˆå–œæ¬¢â€ï¼Œâ€œä¸å–œæ¬¢â€åŒç† -->

    </div>
    {% else %}
        <p><a href="{{ url_for('login') }}">ç™»å½•</a> åå¯ä»¥è¯„ä»·è¿™éƒ¨ç”µå½±ã€‚</p>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const buttons = document.querySelectorAll('.pref-btn');
    // ä½¿ç”¨æ³¨é‡ŠåŒ…è£¹ Jinja2 è¡¨è¾¾å¼ï¼Œé¿å… VSCode JS Linter æŠ¥é”™
    // @ts-ignore
    const movieId = /*{{ movie.MOVIE_ID | tojson }}*/ "{{ movie.MOVIE_ID }}"; // ä» Jinja2 æ¨¡æ¿è·å–ç”µå½± ID
    // @ts-ignore
    const csrfToken = /*{{ csrf_token() | tojson }}*/ "{{ csrf_token() }}"; // è·å– CSRF token

    buttons.forEach(button => {
        button.addEventListener('click', async function () {
            const action = this.dataset.action;

            // ç®€å•çš„åŠ è½½æŒ‡ç¤ºå™¨
            const originalText = this.textContent;
            this.textContent = '...';
            this.disabled = true;

            try {
                // @ts-ignore
                const response = await fetch(/*{{ url_for("toggle_preference_optimized") | tojson }}*/ '{{ url_for("toggle_preference_optimized") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken // å‘é€ CSRF token
                    },
                    body: JSON.stringify({ movie_douban_id: movieId, action: action })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    // æ ¹æ®è¿”å›çš„æ–°çŠ¶æ€æ›´æ–°æŒ‰é’®UI
                    updateButtonUI(data.new_status);
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åå†è¯•ã€‚');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                this.textContent = originalText;
                this.disabled = false;
            }
        });
    });

    function updateButtonUI(newStatus) {
        const likeBtn = document.getElementById('like-btn');
        const dislikeBtn = document.getElementById('dislike-btn');

        // é‡ç½®æŒ‰é’®æ ·å¼å’Œæ–‡æœ¬
        likeBtn.style.backgroundColor = '';
        likeBtn.style.color = '';
        likeBtn.textContent = 'ğŸ‘ å–œæ¬¢';
        dislikeBtn.style.backgroundColor = '';
        dislikeBtn.style.color = '';
        dislikeBtn.textContent = 'ğŸ‘ ä¸å–œæ¬¢';

        if (newStatus === 'liked') {
            likeBtn.style.backgroundColor = 'green';
            likeBtn.style.color = 'white';
            likeBtn.textContent = 'âœ“ å·²å–œæ¬¢';
        } else if (newStatus === 'disliked') {
            dislikeBtn.style.backgroundColor = 'red';
            dislikeBtn.style.color = 'white';
            dislikeBtn.textContent = 'âœ— å·²ä¸å–œæ¬¢';
        }
        // å¦‚æœ newStatus æ˜¯ 'none'ï¼Œåˆ™ä¿æŒé‡ç½®åçš„é»˜è®¤çŠ¶æ€ï¼ˆå·²å–æ¶ˆï¼‰
    }
});
</script>

<style>
    .pref-btn {
        padding: 8px 16px;
        margin-right: 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .pref-btn:hover:not(:disabled) {
        opacity: 0.8;
    }
    .pref-btn:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }
</style>
{% endblock %}