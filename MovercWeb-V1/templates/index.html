<!-- templates/index.html -->

{% extends "base.html" %}

{% block title %}首页{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- 原有的欢迎信息 -->
    <div class="jumbotron">
      <h1 class="display-4">欢迎来到电影推荐系统!</h1>
      <p class="lead">发现下一部你喜欢的电影。</p>
      
      {% if current_user.is_authenticated %}
        <hr class="my-4">
        <p>点击下方按钮开始探索。</p>
        <a class="btn btn-primary btn-lg" href="{{ url_for('recommend') }}" role="button">开始推荐</a>
      {% else %}
        <hr class="my-4">
        <p>请先登录或注册以获得个性化推荐。</p>
        <a class="btn btn-primary btn-lg" href="{{ url_for('login') }}" role="button">登录</a>
        <a class="btn btn-secondary btn-lg" href="{{ url_for('register') }}" role="button">注册</a>
      {% endif %}
    </div>

    <!-- 新增：电影列表部分 -->
    {% if movies %}
        <h2 class="mb-3">热门电影</h2>
        <div class="row">
            {% for movie in movies %}
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        {% if movie.POSTER %} <!-- 确认 POSTER 列存在 -->
                            <img src="{{ movie.POSTER }}" class="card-img-top" alt="{{ movie.NAME }} Poster" style="height: 300px; object-fit: cover;">
                        {% else %}
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 300px;">
                                <span class="text-muted">暂无海报</span>
                            </div>
                        {% endif %}
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ movie.NAME }}</h5> <!-- 确认 NAME 列存在 -->
                            <p class="card-text"><small class="text-muted">{{ movie.YEAR }} | {{ movie.GENRES }}</small></p> <!-- 确认 YEAR, GENRES 列存在 -->
                            <!-- --- 修改：使用实际存在的列名，例如 DESCRIPTION --- -->
                            {% if movie.DESCRIPTION %} <!-- 假设列名是 DESCRIPTION -->
                                <p class="card-text flex-grow-1">{{ movie.DESCRIPTION[:100] ~ ('...' if movie.DESCRIPTION|length > 100 else '') }}</p>
                            {% else %}
                                <p class="card-text flex-grow-1 text-muted">暂无简介。</p>
                            {% endif %}
                            <!-- --- 修改结束 --- -->
                            <!-- --- 同时修正 url_for 的问题，强制转换为字符串 --- -->
                            <a href="{{ url_for('movie_detail', movie_douban_id=movie.MOVIE_ID|string) }}" class="btn btn-primary mt-auto">查看详情</a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info" role="alert">
            目前没有可显示的电影列表。
        </div>
    {% endif %}
</div>
{% endblock %}