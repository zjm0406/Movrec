{% extends "base.html" %}

{% block title %}Welcome to MovRec{% endblock %}

{% block content %}
<h1>Welcome to MovRec</h1>

<!-- æƒé‡æ§åˆ¶é¢æ¿ -->
<div class="card mb-4" style="background-color: #f8f9fa;">
        <div class="card-header">
            <h5 class="mb-0">âš™ï¸ ItemCF-DAVEæ··åˆæ¨èç®—æ³•æƒé‡è°ƒæ•´</h5>
        </div>
    <div class="card-body">
        <div class="text-center mb-3">
            <label for="dvae-slider" class="form-label w-100" style="font-size:1.2rem;font-weight:500;">
                DVAE å†…å®¹ç›¸ä¼¼åº¦æƒé‡: <span id="dvae-value">60</span>%
            </label>
            <small class="text-muted d-block mb-2">åŸºäºç”µå½±å†…å®¹ã€å‰§æƒ…ã€æ ‡ç­¾çš„ç›¸ä¼¼åº¦</small>
            <small class="text-muted d-block">ItemCFï¼ˆåŸºäºç”¨æˆ·å…±ç°/ååŒè¿‡æ»¤ï¼‰ï¼šæ ¹æ®å…¶ä»–ç”¨æˆ·çš„å–œå¥½å…±ç°å…³ç³»æ¨èï¼Œé€‚ç”¨äºæœ‰è¾ƒä¸°å¯Œç”¨æˆ·äº¤äº’æ•°æ®æ—¶æå‡ä¸ªæ€§åŒ–æ•ˆæœã€‚</small>
            <input type="range" class="form-range w-50 mx-auto" id="dvae-slider" min="0" max="100" value="60">
            <div class="mt-3 text-center">
                <button class="btn btn-primary btn-sm px-4" id="save-weights-btn">ğŸ’¾ ä¿å­˜é…ç½®</button>
            </div>
        </div>
        <div id="weights-message" class="mt-2"></div>
    </div>
</div>
<!-- å…¨å±€è¯´æ˜ï¼šå°†æ¨èåé¦ˆæŒ‰é’®çš„ä½œç”¨ç»Ÿä¸€æ”¾åœ¨æœç´¢æ¡†ä¸Šæ–¹ï¼Œé¿å…åœ¨æ¯æ¡æ¨èä¸­é‡å¤æ˜¾ç¤º -->
<div class="card mb-3">
    <div class="card-body small bg-light">
        <strong>å…³äºæ¨èåé¦ˆæŒ‰é’®ï¼ˆè¯´æ˜ï¼‰</strong>
        <ul class="mb-0 mt-1" style="padding-left:1rem">
            <li><strong>âœ“ æœ‰ç”¨ (helpful)ï¼š</strong> è¡¨ç¤ºè¯¥æ¨èå¯¹æ‚¨éå¸¸ç›¸å…³ã€‚ç³»ç»Ÿä¼šæŠŠæ­¤åé¦ˆè®°å½•ä¸ºæ­£æ ·æœ¬ï¼Œç”¨äºè°ƒæ•´ä¸ªæ€§åŒ–æ¨èâ€”â€”çŸ­æœŸå†…æå‡ç›¸ä¼¼é¡¹æ’åºï¼Œé•¿æœŸç”¨äºç¦»çº¿å†è®­ç»ƒæˆ–æ¨¡å‹å¾®è°ƒã€‚</li>
            <li><strong>~ ä¸€èˆ¬ (not_helpful)ï¼š</strong> è¡¨ç¤ºè¯¥æ¨èæœ‰ä¸€å®šå‚è€ƒä»·å€¼ä½†ä¸å¤Ÿè´´åˆ‡ã€‚ç³»ç»Ÿä¼šå°†å…¶è§†ä¸ºä¸­æ€§æˆ–å¼±è´Ÿæ ·æœ¬ï¼Œé€‚åº¦é™ä½ç±»ä¼¼é¡¹ç›®çš„ä¼˜å…ˆçº§ã€‚</li>
            <li><strong>âœ— æ— ç”¨ (dislike)ï¼š</strong> è¡¨ç¤ºè¯¥æ¨èå®Œå…¨ä¸ç›¸å…³æˆ–ä»¤äººåæ„Ÿã€‚ç³»ç»Ÿä¼šæŠŠå®ƒè§†ä¸ºå¼ºè´Ÿæ ·æœ¬ï¼Œæ˜¾è‘—é™ä½ä»Šåå‡ºç°ç›¸ä¼¼æ¨èçš„æ¦‚ç‡ï¼Œå¹¶ç”¨äºè´Ÿæ ·æœ¬è®¡ç®—ã€‚</li>
        </ul>
        <div class="mt-1">
            <em>è¡¥å……ï¼š</em> æäº¤åé¦ˆåç›¸å…³æŒ‰é’®ä¼šæ˜¾ç¤ºâ€œå·²è®°å½•â€å¹¶å¯æ’¤é”€ï¼ˆç‚¹å‡»â€œæ’¤é”€â€ä¼šä»åç«¯åˆ é™¤æœ€è¿‘ä¸€æ¬¡è¯¥æ¡ç›®çš„åé¦ˆå¹¶æ¢å¤æŒ‰é’®çŠ¶æ€ï¼‰ã€‚
        </div>
        <div class="mt-1">
            <em>ä¸â€œå–œæ¬¢/ä¸å–œæ¬¢â€æŒ‰é’®çš„åŒºåˆ«ï¼š</em> â€œå–œæ¬¢/ä¸å–œæ¬¢â€æ˜¯å¯¹ä¸ªäººåå¥½çš„ç›´æ¥æ ‡è®°ï¼Œé€šå¸¸ç«‹å³å½±å“ç”¨æˆ·åå¥½æ¡£æ¡ˆä¸æ¨èæ’åºï¼›è€Œä¸Šæ–¹ä¸‰æŒ‰é’®æ˜¯å¯¹æ¨èç»“æœè´¨é‡çš„è¯„ä»·ï¼Œä¸»è¦ç”¨äºæå‡æ¨¡å‹çš„æ¨èè´¨é‡ä¸è®­ç»ƒæ•°æ®ã€‚
        </div>
    </div>
</div>


<form method="post">
    <div class="input-group mb-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <select class="form-select" name="search_type" style="max-width:140px">
            <option value="movie_name" {% if search_type=='movie_name' or not search_type %}selected{% endif %}>ç”µå½±åç§°</option>
            <option value="director" {% if search_type=='director' %}selected{% endif %}>å¯¼æ¼”</option>
            <!-- actor option removed -->
            <option value="douban_id" {% if search_type=='douban_id' %}selected{% endif %}>è±†ç“£ID</option>
        </select>
        <input type="text" class="form-control" placeholder="è¯·è¾“å…¥æœç´¢å†…å®¹..." name="movie_query" value="{{ query }}" required>
        <div class="input-group-append">
            <button class="btn btn-outline-secondary" type="submit">æœç´¢</button>
        </div>
    </div>
</form>

{% if guess_query %}
<div class="mb-2 text-center text-muted">
    çŒœä½ æƒ³æœï¼š<strong>{{ guess_query }}</strong>
</div>
{% endif %}

{% if recommendations is not none %}
    {% if engine_status == "initializing" %}
        <div class="alert alert-warning" role="alert">
            æ¨èå¼•æ“æ­£åœ¨åˆå§‹åŒ–ï¼Œè¿™å¯èƒ½éœ€è¦ 30-60 ç§’ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰ã€‚è¯·ç¨å€™...
        </div>
    {% elif recommendations.empty %}
        <p>æŠ±æ­‰ï¼Œæ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ¨èã€‚è¯·å°è¯•å…¶ä»–ç”µå½±åã€‚</p>
    {% else %}
        <h3>ä¸ºæ‚¨æ¨è:</h3>
        <div class="row">
        {% for rec in recommendations %}
            {% set mid = rec.get('MOVIE_ID') or '' %}
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100">
                    <div style="width:100%; height:300px; background:#f5f7f9; display:flex; align-items:center; justify-content:center;">
                        <img src="{{ poster_url(rec) }}" class="card-img-top" alt="{{ rec['NAME'] }} Poster" style="max-width:100%; max-height:100%; object-fit:contain;">
                    </div>
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">
                            {% if mid %}
                                    <a href="https://movie.douban.com/subject/{{ mid }}/" target="_blank" rel="noopener">{{ rec['NAME'] }}</a>
                                {% else %}
                                    {{ rec['NAME'] }}
                                {% endif %}
                        </h5>
                        <p class="card-text"><strong>è¯„åˆ†:</strong> {{ rec['DOUBAN_SCORE'] }}</p>
                        <p class="card-text"><strong>æµæ´¾:</strong> {{ rec.get('LABEL') or 'æœªçŸ¥' }}</p>
                        <p class="card-text"><strong>å¯¼æ¼”:</strong> {{ rec.get('DIRECTORS') or 'æœªçŸ¥' }}</p>
                        {# ç›¸ä¼¼åº¦å·²ç§»é™¤ #}

                        <div class="mt-auto">
                            <!-- å–œæ¬¢/ä¸å–œæ¬¢æŒ‰é’® -->
                            <div class="btn-group mb-2 w-100" role="group">
                                <button type="button" class="btn btn-sm btn-outline-success btn-like" data-movie-id="{{ mid }}" data-action="like">ğŸ‘ å–œæ¬¢</button>
                                <button type="button" class="btn btn-sm btn-outline-danger btn-dislike" data-movie-id="{{ mid }}" data-action="dislike">ğŸ‘ ä¸å–œæ¬¢</button>
                            </div>

                            <!-- æ¨èåé¦ˆæŒ‰é’® -->
                            <div class="btn-group w-100" role="group" style="font-size: 0.75rem;">
                                <button type="button" class="btn btn-sm btn-outline-info feedback-btn" data-movie-id="{{ mid }}" data-feedback="helpful" title="è¿™ä¸ªæ¨èå¾ˆç›¸å…³">âœ“ æœ‰ç”¨</button>
                                <button type="button" class="btn btn-sm btn-outline-warning feedback-btn" data-movie-id="{{ mid }}" data-feedback="not_helpful" title="æ¨èè¿˜å¯ä»¥ä½†ä¸å¤Ÿå¥½">~ ä¸€èˆ¬</button>
                                <button type="button" class="btn btn-sm btn-outline-danger feedback-btn" data-movie-id="{{ mid }}" data-feedback="dislike" title="æ¨èå®Œå…¨ä¸ç›¸å…³">âœ— æ— ç”¨</button>
                            </div>
        
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
        </div>

        <script>
        const csrfToken = "{{ csrf_token() }}";
        
        // ========== æƒé‡æ§åˆ¶ ==========
        const dvaeSlider = document.getElementById('dvae-slider');
        const dvaeValue = document.getElementById('dvae-value');
        const saveWeightsBtn = document.getElementById('save-weights-btn');
        const weightsMessage = document.getElementById('weights-message');

        // åŠ è½½å·²ä¿å­˜çš„ç”¨æˆ·æƒé‡
        async function loadUserWeights() {
            try {
                const res = await fetch('{{ url_for("get_user_weights") }}', {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                if (res.ok) {
                    const data = await res.json();
                    if (data.success) {
                        const dvae = Math.round(data.dvae_weight * 100);
                        dvaeSlider.value = dvae;
                        updateWeightDisplay();
                    }
                }
            } catch (err) {
                console.error('åŠ è½½æƒé‡å¤±è´¥:', err);
            }
        }

        function updateWeightDisplay() {
            dvaeValue.textContent = dvaeSlider.value;
        }

        dvaeSlider.addEventListener('input', updateWeightDisplay);

        saveWeightsBtn.addEventListener('click', async function() {
            const dvae = parseInt(dvaeSlider.value) / 100;
            // Only send dvae weight; backend will compute itemcf = 1 - dvae
            
            try {
                const res = await fetch('{{ url_for("set_user_weights") }}', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({
                        dvae_weight: dvae
                    })
                });

                const data = await res.json();
                if (data.success) {
                    weightsMessage.innerHTML = '<div class="alert alert-success mb-0">âœ“ ' + data.message + '</div>';
                    setTimeout(() => {
                        weightsMessage.innerHTML = '';
                    }, 3000);
                } else {
                    weightsMessage.innerHTML = '<div class="alert alert-danger mb-0">âœ— ä¿å­˜å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯') + '</div>';
                }
            } catch (err) {
                console.error(err);
                weightsMessage.innerHTML = '<div class="alert alert-danger mb-0">âœ— ç½‘ç»œé”™è¯¯</div>';
            }
        });

        // ========== æ¨èåé¦ˆ ==========
        document.querySelectorAll('.feedback-btn').forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.preventDefault();
                const movieId = this.dataset.movieId;
                const feedback = this.dataset.feedback;
                const queryMovie = "{{ query }}";
                if (!movieId) {
                    alert('æ­¤æ¡ç›®æ²¡æœ‰å¯ç”¨çš„è±†ç“£ ID');
                    return;
                }

                const origText = this.innerHTML;
                const btnEl = this;
                btnEl.disabled = true;
                btnEl.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

                try {
                    const res = await fetch('{{ url_for("submit_recommendation_feedback") }}', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            query_movie_id: queryMovie,
                            recommended_movie_id: movieId,
                            feedback: feedback,
                            recommendation_method: 'hybrid'
                        })
                    });

                    const data = await res.json();
                    if (data.success) {
                        // æ ‡è®°ä¸ºå·²è®°å½•å¹¶ç¦æ­¢å†æ¬¡ç‚¹å‡»ï¼›æ˜¾ç¤ºæ’¤é”€æŒ‰é’®
                        btnEl.classList.add('feedback-recorded');
                        btnEl.innerHTML = 'âœ“ å·²è®°å½•';
                        btnEl.disabled = true;

                        // åˆ›å»ºæ’¤é”€æŒ‰é’®ï¼ˆå¦‚æœå°šæœªå­˜åœ¨ï¼‰
                        let undoBtn = btnEl.parentElement.querySelector('.undo-feedback');
                        if (!undoBtn) {
                            undoBtn = document.createElement('button');
                            undoBtn.type = 'button';
                            undoBtn.className = 'btn btn-sm btn-link undo-feedback';
                            undoBtn.style.marginLeft = '6px';
                            undoBtn.textContent = 'æ’¤é”€';
                            btnEl.parentElement.appendChild(undoBtn);

                            undoBtn.addEventListener('click', async function(ev) {
                                ev.preventDefault();
                                undoBtn.disabled = true;
                                try {
                                    const undoRes = await fetch('{{ url_for("undo_recommendation_feedback") }}', {
                                        method: 'POST',
                                        credentials: 'same-origin',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'X-CSRFToken': csrfToken
                                        },
                                        body: JSON.stringify({
                                            recommended_movie_id: movieId,
                                            query_movie_id: queryMovie
                                        })
                                    });
                                    const undoData = await undoRes.json();
                                    if (undoData.success) {
                                        // æ¢å¤æŒ‰é’®åˆå§‹çŠ¶æ€å¹¶ç§»é™¤æ’¤é”€æŒ‰é’®
                                        btnEl.classList.remove('feedback-recorded');
                                        btnEl.disabled = false;
                                        btnEl.innerHTML = origText;
                                        undoBtn.remove();
                                    } else {
                                        alert(undoData.message || 'æ’¤é”€å¤±è´¥');
                                        undoBtn.disabled = false;
                                    }
                                } catch (ue) {
                                    console.error(ue);
                                    alert('ç½‘ç»œé”™è¯¯ï¼Œæ’¤é”€å¤±è´¥');
                                    undoBtn.disabled = false;
                                }
                            });
                        }
                    } else {
                        alert('åé¦ˆæäº¤å¤±è´¥');
                        btnEl.disabled = false;
                        btnEl.innerHTML = origText;
                    }
                } catch (err) {
                    console.error(err);
                    alert('ç½‘ç»œé”™è¯¯');
                    btnEl.disabled = false;
                    btnEl.innerHTML = origText;
                }
            });
        });

        // ========== å–œæ¬¢/ä¸å–œæ¬¢åŠŸèƒ½ ==========
        document.addEventListener('DOMContentLoaded', function(){
            loadUserWeights();
            
            document.querySelectorAll('.btn-like, .btn-dislike').forEach(btn => {
                btn.addEventListener('click', async function(e){
                    const movieId = this.dataset.movieId;
                    const action = this.dataset.action;
                    const btnEl = this;

                    if(!movieId){
                        alert('æ­¤æ¡ç›®æ²¡æœ‰å¯ç”¨çš„è±†ç“£ ID');
                        return;
                    }

                    const origText = btnEl.innerHTML;
                    btnEl.disabled = true;
                    btnEl.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                    // small message area inside the card (create if missing)
                    const cardBody = btnEl.closest('.card-body');
                    let prefMsg = cardBody.querySelector('.pref-message');
                    if(!prefMsg){
                        prefMsg = document.createElement('div');
                        prefMsg.className = 'pref-message mt-2';
                        cardBody.appendChild(prefMsg);
                    }
                    prefMsg.innerHTML = '';
                    let successFlag = false;
                    try{
                        const res = await fetch('{{ url_for("toggle_preference_optimized") }}', {
                            method: 'POST',
                            credentials: 'same-origin',
                            headers: {
                                'Content-Type':'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify({movie_douban_id: movieId, action: action})
                        });

                        const contentType = res.headers.get('content-type') || '';
                        if(!res.ok){
                            if(contentType.indexOf('application/json') !== -1){
                                const errData = await res.json();
                                alert(errData.error || 'æ“ä½œå¤±è´¥');
                            } else {
                                alert('æ“ä½œå¤±è´¥ï¼ŒHTTP ' + res.status);
                            }
                            return;
                        }

                        if(contentType.indexOf('application/json') === -1){
                            const txt = await res.text();
                            const lowered = txt.toLowerCase();
                            if(lowered.includes('login')){
                                if(confirm('éœ€è¦ç™»å½•ï¼Œæ˜¯å¦å‰å¾€ç™»å½•é¡µï¼Ÿ')){
                                    window.location.href = '{{ url_for("login") }}';
                                }
                                return;
                            }
                            alert('æ“ä½œå¤±è´¥ï¼ˆé JSON å“åº”ï¼‰');
                            return;
                        }

                        const data = await res.json();
                        if(data && data.success){
                            const parent = btnEl.closest('.card-body');
                            const likeBtn = parent.querySelector('.btn-like');
                            const dislikeBtn = parent.querySelector('.btn-dislike');
                            likeBtn.classList.remove('btn-success');
                            dislikeBtn.classList.remove('btn-danger');
                            if(data.new_status === 'liked'){
                                likeBtn.classList.add('btn-success');
                                likeBtn.innerText = 'âœ“ å·²å–œæ¬¢';
                                dislikeBtn.innerText = 'ğŸ‘ ä¸å–œæ¬¢';
                            } else if(data.new_status === 'disliked'){
                                dislikeBtn.classList.add('btn-danger');
                                dislikeBtn.innerText = 'âœ— å·²ä¸å–œæ¬¢';
                                likeBtn.innerText = 'ğŸ‘ å–œæ¬¢';
                            } else {
                                likeBtn.innerText = 'ğŸ‘ å–œæ¬¢';
                                dislikeBtn.innerText = 'ğŸ‘ ä¸å–œæ¬¢';
                            }
                            // show short success hint
                            if(prefMsg) prefMsg.innerHTML = '<div class="alert alert-success py-1">å·²æ›´æ–°åå¥½</div>';
                            successFlag = true;
                        } else if(data && data.error){
                            if(prefMsg) prefMsg.innerHTML = '<div class="alert alert-danger py-1">' + (data.error||'æ“ä½œå¤±è´¥') + '</div>';
                        } else {
                            if(prefMsg) prefMsg.innerHTML = '<div class="alert alert-danger py-1">æ“ä½œå¤±è´¥ï¼ˆæœªçŸ¥å“åº”ï¼‰</div>';
                        }
                    } catch(err){
                        console.error(err);
                        if(prefMsg) prefMsg.innerHTML = '<div class="alert alert-danger py-1">ç½‘ç»œé”™è¯¯</div>';
                    } finally{
                        // åªåœ¨å¤±è´¥æ—¶æ¢å¤åŸå§‹æ–‡æœ¬ï¼›æˆåŠŸæ—¶ä¿ç•™æ›´æ–°çš„æŒ‰é’®æ–‡æ¡ˆ
                        if(!successFlag){
                            btnEl.disabled = false;
                            btnEl.innerHTML = origText;
                        } else {
                            btnEl.disabled = false;
                        }
                        // è‡ªåŠ¨æ¸…ç†æç¤º
                        if(prefMsg){
                            setTimeout(()=>{ prefMsg.innerHTML = ''; }, 2000);
                        }
                    }
                });
            });
        });
        </script>
    {% endif %}
{% endif %}

{% endblock %}
